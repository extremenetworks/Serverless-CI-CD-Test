version: '1.0'
stages:
  - clone
  - prepare
  - pre-deploy
  - deploy
steps:
  main_clone:
    title: Cloning main repository...
    type: git-clone
    repo: '${{CF_REPO_OWNER}}/${{CF_REPO_NAME}}'
    revision: '${{CF_REVISION}}'
    stage: clone
    git: CF-default

  setup:
    image: alpine:3.7
    stage: prepare
    title: generate GCP shared credentials file
    commands:
      - mkdir -p .gcloud
      - echo -n $GCP_CREDENTIALS_FILE | base64 -d > ${PWD}/.gcloud/keyfile.json
      - cf_export GCP_SHARED_CREDENTIALS_FILE=${PWD}/.gcloud/keyfile.json

  lint_build:
    image: nikolaik/python-nodejs:latest
    title: lint
    stage: pre-deploy
    working_directory: ${{main_clone}}/ts-sandbox
    commands:
      - npm install package.json

  unitTest:
    image: nikolaik/python-nodejs:latest
    title: Unit Test using firebase cloud shell
    stage: pre-deploy
    working_directory: ${{main_clone}}/ts-sandbox
    commands:
      - npm install package.json
      - npm install -g firebase-tools
      - firebase use --add saas-cloud-prototype
      - pip install -r requirements.txt
      - python tests/curl.py
      
  package:
    image: codefresh/serverless:1.28
    stage: pre-deploy
    title: package serverless service
    working_directory: ${{main_clone}}/ts-sandbox/functions
    commands:
      - serverless package --package ${PACKAGE}

  deploy:
    image: codefresh/serverless:1.28
    stage: deploy
    title: deploy to GCP with serverless framework
    working_directory: ${{main_clone}}
    commands:
      - serverless deploy
